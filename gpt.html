<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒç½®ãæ›ãˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        label, input { margin-bottom: 10px; display: block; }
        .file-button { padding: 12px 24px; background-color: #4caf50; color: white; border-radius: 4px; cursor: pointer; }
        .file-button:hover { background-color: #45a049; }
        textarea { width: 100%; height: 200px; }
        iframe { width: 100%; height: 500px; border: 1px solid #ccc; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ç”»åƒç½®ãæ›ãˆãƒ„ãƒ¼ãƒ«</h1>
    <label for="target-site">å¯¾è±¡ã‚µã‚¤ãƒˆã®URLï¼š</label>
    <input type="text" id="target-site" placeholder="ä¾‹: https://example.com">
    
    <label>ç”»åƒã®é¸æŠæ–¹æ³•ï¼š</label>
    <input type="radio" name="image-source" value="url" checked> URLã§æŒ‡å®š
    <input type="radio" name="image-source" value="file"> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
    
    <div id="url-input-area">
        <label for="new-image-url">æ–°ã—ã„ç”»åƒã®URLï¼š</label>
        <input type="text" id="new-image-url" placeholder="ä¾‹: https://example.com/image.jpg">
    </div>
    
    <div id="file-input-area" style="display: none">
        <label for="image-input" class="file-button">ğŸ“ ç”»åƒã‚’é¸æŠ</label>
        <input type="file" id="image-input" accept="image/*" style="display: none">
        <p id="selected-file-name">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
        <img id="preview-image" style="max-width: 200px; display: none">
    </div>
    
    <button onclick="replaceImages()">ç”»åƒã‚’ç½®æ›</button>
    <div id="result"></div>
    <h3>ç½®æ›å¾Œã®HTMLï¼š</h3>
    <textarea id="output-html" readonly></textarea>
    <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼š</h3>
    <iframe id="preview-frame"></iframe>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('input[name="image-source"]').forEach(radio => {
                radio.addEventListener("change", function () {
                    document.getElementById("url-input-area").style.display = this.value === "url" ? "block" : "none";
                    document.getElementById("file-input-area").style.display = this.value === "file" ? "block" : "none";
                });
            });

            document.getElementById("image-input").addEventListener("change", function () {
                const file = this.files[0];
                if (file) {
                    document.getElementById("selected-file-name").textContent = `é¸æŠä¸­: ${file.name}`;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById("preview-image").src = e.target.result;
                        document.getElementById("preview-image").style.display = "block";
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        async function replaceImages() {
            const targetSite = document.getElementById("target-site").value;
            const imageSource = document.querySelector('input[name="image-source"]:checked').value;
            let imageData;

            if (!targetSite) return alert("å¯¾è±¡ã‚µã‚¤ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            try {
                if (imageSource === "url") {
                    imageData = document.getElementById("new-image-url").value;
                    if (!imageData) return alert("ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                } else {
                    const file = document.getElementById("image-input").files[0];
                    if (!file) return alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
                    imageData = await convertImageToBase64(file);
                }

                const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(targetSite)}`);
                let html = await response.text();
                html = replaceImgSrc(html, imageData);
                
                document.getElementById("output-html").textContent = html;
                document.getElementById("preview-frame").srcdoc = html;
                
                const blob = new Blob([html], { type: "text/html" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "modified.html";
                link.textContent = "ç”Ÿæˆã•ã‚ŒãŸHTMLã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
                document.getElementById("result").innerHTML = "";
                document.getElementById("result").appendChild(link);
            } catch (error) {
                console.error("ã‚¨ãƒ©ãƒ¼è©³ç´°:", error);
                alert("ç”»åƒç½®æ›å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚„å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function replaceImgSrc(html, newSrc) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            doc.querySelectorAll("img").forEach(img => img.src = newSrc);
            return doc.documentElement.outerHTML;
        }

        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => {
                    alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚");
                    reject("ç”»åƒã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼");
                };
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>